var RongWebIMWidget;!function(a){var b;!function(a){angular.module("RongWebIMWidget.conversation",[])}(b=a.conversation||(a.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(a){angular.module("RongWebIMWidget.conversationlist",[])}(b=a.conversationlist||(a.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){angular.module("RongWebIMWidget",["RongWebIMWidget.conversation","RongWebIMWidget.conversationlist","Evaluate"])}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b=window.navigator.userAgent.toLowerCase(),c=function(){function a(){}return a.timeCompare=function(a,b){var c=a.toString(),d=b.toString();return c.substring(0,c.lastIndexOf(":"))==d.substring(0,d.lastIndexOf(":"))},a.cloneObject=function(b){if(!b)return null;var c;if("[object Array]"==Object.prototype.toString.call(b)){c=[];for(var d=b.length;d--;)c[d]=a.cloneObject(b[d]);return c}if("object"==typeof b){c={};for(var e in b)c[e]=b[e];return c}return b},a.discernUrlEmailInStr=function(a){var b,c=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/gi,d=[];b=a.replace(c,function(a){return d.push(a),"[email`"+(d.length-1)+"]"});var e=/(((ht|f)tp(s?))\:\/\/)?((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|(www.|[a-zA-Z].)[a-zA-Z0-9\-\.]+\.(com|cn|edu|gov|mil|net|org|biz|info|name|museum|us|ca|uk|me|im))(\:[0-9]+)*(\/($|[a-zA-Z0-9\.\,\;\?\'\\\+&amp;%\$#\=~_\-]+))*/gi;b=b.replace(e,function(a,b){return b?'<a target="_blank" href="'+a+'">'+a+"</a>":'<a target="_blank" href="//'+a+'">'+a+"</a>"});for(var f=0,g=d.length;g>f;f++)b=b.replace("[email`"+f+"]",'<a href="mailto:'+d[f]+'">'+d[f]+"<a>");return b},a.checkType=function(a){var b=Object.prototype.toString.call(a);return b.substring(8,b.length-1).toLowerCase()},a.browser={version:(b.match(/.+(?:rv|it|ra|chrome|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(b),opera:/opera|opr/.test(b),msie:/msie|trident/.test(b)&&!/opera/.test(b),chrome:/chrome/.test(b),mozilla:/mozilla/.test(b)&&!/(compatible|webkit|like gecko)/.test(b)},a.escapeSymbol={encodeHtmlsymbol:function(a){return a?(a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/"/g,"&quot;"),a=a.replace(/'/g,"&#039;")):""},decodeHtmlsymbol:function(a){return a?(a=a.replace(/&amp;/g,"&"),a=a.replace(/&lt;/g,"<"),a=a.replace(/&gt;/g,">"),a=a.replace(/&quot;/g,'"'),a=a.replace(/&#039;/g,"'")):""}},a.getFocus=function(b){if(b.focus(),b.createTextRange){var c=b.createTextRange();c.moveStart("character",b.value.length),c.collapse(!0),c.select()}else if(b.selectionStart)b.selectionStart=b.value.length;else if(window.getSelection&&b.lastChild){var d=window.getSelection(),e=document.createRange();a.browser.msie?e.setStart(b.lastChild,b.lastChild.length):e.setStart(b.firstChild,b.firstChild.length),d.removeAllRanges(),d.addRange(e)}},a.ImageHelper={getThumbnail:function(b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;g.onload=function(){var a,h,i=g.width*g.height;if(i>c){var j=Math.sqrt(i/c);j=Math.ceil(100*j)/100,a=g.width/j,h=g.height/j}else a=g.width,h=g.height;e.width=a,e.height=h,f.drawImage(g,0,0,a,h);try{var k=e.toDataURL("image/jpeg",.5);k=k.substr(23),d(b,k)}catch(l){d(b,null)}},"string"==typeof b?g.src=b:g.src=a.ImageHelper.getFullPath(b)},getFullPath:function(a){return window.URL=window.URL||window.webkitURL,window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null}},a.CookieHelper={setCookie:function(a,b,c){if(c){var d=new Date;d.setDate(d.getDate()+c),document.cookie=a+"="+encodeURI(b)+";expires="+d.toUTCString()}else document.cookie=a+"="+encodeURI(b)+";"},getCookie:function(a){var b=document.cookie.indexOf(a+"=");if(-1!=b){var c=document.cookie.indexOf(";",b);return-1==c&&(c=document.cookie.length),decodeURI(document.cookie.substring(b+a.length+1,c))}return""},removeCookie:function(a){var b=this.getCookie(a);b&&this.setCookie(a,"con",-1)}},a}();a.Helper=c;var d=function(){function a(){}return a.isNotificationSupported=function(){return"function"==typeof Notification||"object"==typeof Notification},a.requestPermission=function(){a.isNotificationSupported()&&Notification.requestPermission(function(a){})},a.onclick=function(a){},a.showNotification=function(b){if(!a.isNotificationSupported())return void console.log("the current browser does not support Notification API");if("granted"!==Notification.permission)return void console.log("the current page has not been granted for notification");if(a.desktopNotification){var c=b.title;delete b.title;var d=new Notification(c,b);d.onshow=function(){setTimeout(function(){d.close()},5e3)},d.onclick=function(){window.focus(),a.onclick&&a.onclick(d),d.close()},d.onerror=function(){},d.onclose=function(){}}},a.desktopNotification=!0,a}();a.NotificationHelper=d;var e=function(){function a(){}return a.GetFactoryFor=function(a){var b=function(){for(var b=[],c=0;c<arguments.length;c++)b[c-0]=arguments[c];var d=Object.create(a.prototype);return d.constructor.apply(d,b),d};return b.$inject=a.$inject,b},a}();a.DirectiveFactory=e;var f=function(){function a(){}return a.instance=function(){return new a},a.prototype.link=function(a,b,c){c.ngSrc||c.$set("src",c.errSrc),b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)})},a}(),g=function(){function a(){this.restrict="A",this.require="?ngModel"}return a.prototype.link=function(a,b,d,e){function f(a){return a.replace(new RegExp("<[\\s\\S.]*?>","ig"),"")}function g(){var a=b.html(),a=c.escapeSymbol.decodeHtmlsymbol(a);a=a.replace(/^<br>$/i,""),a=a.replace(/<br>/gi,"\n"),d.stripBr&&"<br>"==a&&(a=""),e.$setViewValue(a)}var h=b[0];a.$watch(function(){return e.$modelValue},function(a){document.activeElement!==h&&(""!==a&&a!==d.placeholder||(h.innerHTML=d.placeholder,h.style.color="#a9a9a9",e.$setViewValue("")))}),b.bind("focus",function(){h.innerHTML==d.placeholder&&(h.innerHTML=""),h.style.color=""}),b.bind("blur",function(){""===h.innerHTML&&(h.innerHTML=d.placeholder,h.style.color="#a9a9a9")}),e&&(b.bind("paste",function(a){var b,c=this;a.preventDefault(),a.clipboardData||a.originalEvent&&a.originalEvent.clipboardData?(b=(a.originalEvent||a).clipboardData.getData("text/plain"),b=f(b||""),b&&document.execCommand("insertText",!1,b)):window.clipboardData&&(b=window.clipboardData.getData("Text"),b=f(b||""),document.selection?b&&document.selection.createRange().pasteHTML(b):document.getSelection&&document.getSelection().getRangeAt(0).insertNode(document.createTextNode(b))),e.$setViewValue(c.innerHTML)}),e.$render=function(){b.html(e.$viewValue||"")},b.bind("keyup paste",g),b.bind("input",g))},a}(),h=function(){function a(){this.restrict="A",this.require="?ngModel",this.scope={fun:"&",ctrlenter:"=",content:"="}}return a.prototype.link=function(a,b,c,d){a.ctrlenter=a.ctrlenter||!1,b.bind("keypress",function(b){a.ctrlenter?(b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode)&&(a.fun(),a.$parent.$apply(),b.preventDefault()):b.ctrlKey!==!1||b.shiftKey!==!1||13!==b.keyCode&&10!==b.keyCode?b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode:(a.fun(),a.$parent.$apply(),b.preventDefault())})},a}();angular.module("RongWebIMWidget").directive("errSrc",f.instance).directive("contenteditableDire",e.GetFactoryFor(g)).directive("ctrlEnterKeys",e.GetFactoryFor(h)).filter("trustHtml",["$sce",function(a){return function(b){var c=a.trustAsHtml(b);return c}}]).filter("historyTime",["$filter",function(a){return function(b){var c=new Date;return b.toDateString()===c.toDateString()?a("date")(b,"HH:mm"):b.toDateString()===new Date(c.setTime(c.getTime()-1)).toDateString()?"昨天"+a("date")(b,"HH:mm"):a("date")(b,"yyyy-MM-dd HH:mm")}}])}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(b){var c="http://7xogjk.com1.z0.glb.clouddn.com/",d=function(){function b(b,d,e,f,g,h,i){function j(){i.getFileToken().then(function(b){d._uploadToken=b,a.Helper.browser.msie&&"9.0"==a.Helper.browser.version?l():m()})}function k(c,e){var g=RongIMLib.ImageMessage.obtain(c,e),c=n.packDisplaySendMessage(g,a.MessageType.ImageMessage);RongIMLib.RongIMClient.getInstance().sendMessage(b.conversation.targetType,b.conversation.targetId,g,{onSuccess:function(){f.updateConversations().then(function(){})},onError:function(){}}),d._addHistoryMessages(a.Message.convert(c)),b.$apply(function(){b.scrollBar()})}function l(){g.uploadFlashUrl||console.log("请在 init 时添加 flash 文件地址配置 uploadFlashUrl"),$("#upload-file").FileToDataURI({moviePath:g.uploadFlashUrl||"/rong_widget/images/FileToDataURI.swf",multiple:!0,allowedExts:["js","png","jpg","jpeg"],forceFlash:!1,token:d._uploadToken,onSelect:function(b,c){a.Helper.ImageHelper.getThumbnail(b[0].data,6e4,function(a,d){var e=b[0].data,f=new RegExp("^data:image/[^;]+;base64,");e=e.replace(f,""),RongIMLib.RongIMClient.getInstance().getFileUrl(RongIMLib.FileType.IMAGE,c.filename,"",{onSuccess:function(a){k(d,a.downloadUrl)},onError:function(){}})})}})}function m(){a.Helper.browser.msie&&"9.0"==a.Helper.browser.version||(o&&o.destroy(),o=Qiniu.uploader({runtimes:"html5,html4",browse_button:"upload-file",container:"funcPanel",drop_element:"inputMsg",max_file_size:"100mb",dragdrop:!0,chunk_size:"4mb",unique_names:!0,uptoken:d._uploadToken,domain:c,get_new_uptoken:!1,filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg,bmp"}],prevent_duplicates:!1},multi_selection:!1,auto_start:!0,init:{FilesAdded:function(a,b){},BeforeUpload:function(a,b){},UploadProgress:function(a,b){},UploadComplete:function(){},FileUploaded:function(c,d,e){return b.conversation.targetId&&b.conversation.targetType?(e=e.replace(/'/g,'"'),e=JSON.parse(e),void RongIMLib.RongIMClient.getInstance().getFileUrl(RongIMLib.FileType.IMAGE,d.target_name,"",{onSuccess:function(b){a.Helper.ImageHelper.getThumbnail(d.getNative(),6e4,function(a,c){k(c,b.downloadUrl)})},onError:function(){}})):void alert("请先选择一个会话目标。")},Error:function(a,b,c){console.log(b),j()}}}))}this.$scope=b,this.conversationServer=d,this.WebIMWidget=e,this.conversationListServer=f,this.widgetConfig=g,this.providerdata=h,this.RongIMSDKServer=i;var n=this;n.busy=!1,d.changeConversation=function(a){n.changeConversation(a)},d.handleMessage=function(a){n.handleMessage(a)},d._handleConnectSuccess=function(){j()},b.evaluate={type:1,showevaluate:!1,valid:!1,onConfirm:function(c){c&&(b.evaluate.type==a.EnumCustomerStatus.person?i.evaluateHumanCustomService(d.current.targetId,c.stars,c.describe).then(function(){},function(){}):i.evaluateRebotCustomService(d.current.targetId,c.value,c.describe).then(function(){},function(){})),n.conversationServer._customService.connected=!1,RongIMLib.RongIMClient.getInstance().stopCustomeService(d.current.targetId,{onSuccess:function(){},onError:function(){}}),n.busy=!1,n.closeState()},onCancle:function(){b.evaluate.showSelf=!1}},b._inputPanelState=a.EnumInputPanelType.person,b.$watch("showemoji",function(a,c){a!==c&&(b.emojiList&&0!=b.emojiList.length||(b.emojiList=RongIMLib.RongIMEmoji.emojis.slice(0,70)))}),document.addEventListener("click",function(a){b.showemoji&&-1==a.target.className.indexOf("iconfont-smile")&&b.$apply(function(){b.showemoji=!1})}),b.$watch("showSelf",function(a,b){a!==b&&(a&&d._uploadToken?m():o&&o.destroy())}),b.$watch("_inputPanelState",function(b,c){b!==c&&(b==a.EnumInputPanelType.person&&d._uploadToken?m():o&&o.destroy())}),b.$watch("conversation.messageContent",function(a,c){a!==c&&b.conversation&&RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(+b.conversation.targetType,b.conversation.targetId,a)}),b.getHistory=function(){var c=b.conversation.targetType+"_"+b.conversation.targetId,e=d._cacheHistory[c];e.splice(0,e.length),d._getHistoryMessages(+b.conversation.targetType,b.conversation.targetId,20).then(function(b){var e=d._cacheHistory[c][0];e&&d._cacheHistory[c].unshift(new a.TimePanel(e.sentTime)),b.has&&d._cacheHistory[c].unshift(new a.GetMoreMessagePanel)})},b.getMoreMessage=function(){var c=b.conversation.targetType+"_"+b.conversation.targetId;d._cacheHistory[c].shift(),d._cacheHistory[c].shift(),d._getHistoryMessages(+b.conversation.targetType,b.conversation.targetId,20).then(function(b){d._cacheHistory[c].unshift(new a.TimePanel(d._cacheHistory[c][0].sentTime)),b.has&&d._cacheHistory[c].unshift(new a.GetMoreMessagePanel)})},b.switchPerson=function(){RongIMLib.RongIMClient.getInstance().switchToHumanMode(d.current.targetId,{onSuccess:function(){},onError:function(){}})},b.send=function(){if(!b.conversation.targetId||!b.conversation.targetType)return void alert("请先选择一个会话目标。");if(""!=b.conversation.messageContent){var c=RongIMLib.RongIMEmoji.symbolToEmoji(b.conversation.messageContent),e=RongIMLib.TextMessage.obtain(c),g=new RongIMLib.UserInfo(h.currentUserInfo.userId,h.currentUserInfo.name,h.currentUserInfo.portraitUri);e.user=g;try{RongIMLib.RongIMClient.getInstance().sendMessage(+b.conversation.targetType,b.conversation.targetId,e,{onSuccess:function(a){f.updateConversations().then(function(){})},onError:function(a){}})}catch(i){}var j=n.packDisplaySendMessage(e,a.MessageType.TextMessage),k=a.Message.convert(j);d._addHistoryMessages(k),b.scrollBar(),b.conversation.messageContent="";var l=document.getElementById("inputMsg");a.Helper.getFocus(l)}};var o;b.close=function(){if(e.onCloseBefore&&"function"==typeof e.onCloseBefore){e.onCloseBefore({close:function(c){d.current.targetType==a.EnumConversationType.CUSTOMER_SERVICE?b.evaluate.valid?(n.busy=!0,b.evaluate.showSelf=!0):(RongIMLib.RongIMClient.getInstance().stopCustomeService(d.current.targetId,{onSuccess:function(){},onError:function(){}}),d._customService.connected=!1,n.closeState()):n.closeState()}})}else d.current.targetType==a.EnumConversationType.CUSTOMER_SERVICE?b.evaluate.valid?(n.busy=!0,b.evaluate.showSelf=!0):(RongIMLib.RongIMClient.getInstance().stopCustomeService(d.current.targetId,{onSuccess:function(){},onError:function(){}}),d._customService.connected=!1,n.closeState()):n.closeState()},b.minimize=function(){e.display=!1}}return b.prototype.closeState=function(){var a=this;this.WebIMWidget.onClose&&"function"==typeof this.WebIMWidget.onClose&&setTimeout(function(){a.WebIMWidget.onClose(a.$scope.conversation)},1),this.widgetConfig.displayConversationList?this.$scope.showSelf=!1:this.WebIMWidget.display=!1,this.$scope.messageList=[],this.$scope.conversation=null,this.conversationServer.current=null,a.$scope.evaluate.showSelf=!1},b.prototype.changeConversation=function(b){var c=this;if(!c.busy){if(c.widgetConfig.displayConversationList?c.$scope.showSelf=!0:(c.$scope.showSelf=!0,c.WebIMWidget.display=!0),!b||!b.targetId)return c.$scope.conversation={},c.$scope.messageList=[],c.conversationServer.current=null,void setTimeout(function(){c.$scope.$apply()});var d=b.targetType+"_"+b.targetId,e=b.targetType==a.EnumConversationType.CUSTOMER_SERVICE;if(e){var f=c.conversationServer.getCacheCustomService(b.targetType,b.targetId);c.conversationServer._customService=f,f&&f.connected?c.changeCustomerState(f.inputPanelState):c.RongIMSDKServer.startCustomService(b.targetId)}else c.changeCustomerState(a.EnumInputPanelType.person);c.conversationServer.current=b,c.$scope.conversation=b,c.$scope.conversation.messageContent=RongIMLib.RongIMClient.getInstance().getTextMessageDraft(b.targetType,b.targetId)||"",c.$scope.messageList=c.conversationServer._cacheHistory[d]=c.conversationServer._cacheHistory[d]||[],0==c.$scope.messageList.length&&c.conversationServer.current.targetType!==a.EnumConversationType.CUSTOMER_SERVICE?(c.conversationServer._getHistoryMessages(b.targetType,b.targetId,3).then(function(b){c.$scope.messageList.length>0&&(c.$scope.messageList.unshift(new a.TimePanl(c.$scope.messageList[0].sentTime)),b.has&&c.$scope.messageList.unshift(new a.GetMoreMessagePanel),setTimeout(function(){c.$scope.$apply()}),c.$scope.scrollBar())}),c.$scope.$$phase||c.$scope.$digest()):(setTimeout(function(){c.$scope.$apply()}),c.$scope.scrollBar())}},b.prototype.handleMessage=function(b){var c=this;if(c.$scope.conversation&&b.targetId==c.$scope.conversation.targetId&&b.conversationType==c.$scope.conversation.targetType){c.$scope.$apply();var d=null;switch(b.messageType){case a.MessageType.HandShakeResponseMessage:"1"==b.content.data.serviceType?(c.changeCustomerState(a.EnumInputPanelType.robot),b.content.data.robotWelcome&&(d=this.packReceiveMessage(RongIMLib.TextMessage.obtain(b.content.data.robotWelcome),a.MessageType.TextMessage))):"3"==b.content.data.serviceType?(b.content.data.robotWelcome&&(d=this.packReceiveMessage(RongIMLib.TextMessage.obtain(b.content.data.robotWelcome),a.MessageType.TextMessage)),c.changeCustomerState(a.EnumInputPanelType.robotSwitchPerson)):c.changeCustomerState(a.EnumInputPanelType.person),c.$scope.evaluate.valid=!1,c.$scope.evaluate.showSelf=!1,setTimeout(function(){c.$scope.evaluate.valid=!0},6e4),c.providerdata._productInfo&&c.RongIMSDKServer.sendProductInfo(c.conversationServer.current.targetId,c.providerdata._productInfo);break;case a.MessageType.ChangeModeResponseMessage:switch(b.content.data.status){case 1:c.changeCustomerState(a.EnumInputPanelType.person);break;case 2:"2"==c.conversationServer._customService.type?c.changeCustomerState(a.EnumInputPanelType.person):"1"!=c.conversationServer._customService.type&&"3"!=c.conversationServer._customService.type||c.changeCustomerState(a.EnumInputPanelType.robotSwitchPerson);break;case 3:c.changeCustomerState(a.EnumInputPanelType.robot),d=this.packReceiveMessage(RongIMLib.InformationNotificationMessage.obtain("你被拉黑了"),a.MessageType.InformationNotificationMessage);break;case 4:c.changeCustomerState(a.EnumInputPanelType.person),d=c.packReceiveMessage(RongIMLib.InformationNotificationMessage.obtain("已经是人工了"),a.MessageType.InformationNotificationMessage)}break;case a.MessageType.TerminateMessage:c.conversationServer._customService.connected=!1,0==b.content.code?(c.$scope.evaluate.valid=!0,c.$scope.close()):"1"==c.conversationServer._customService.type?c.changeCustomerState(a.EnumInputPanelType.robot):c.changeCustomerState(a.EnumInputPanelType.robotSwitchPerson);break;case a.MessageType.SuspendMessage:b.messageDirection==a.MessageDirection.SEND&&(c.conversationServer._customService.connected=!1,c.closeState());break;case a.MessageType.CustomerStatusUpdateMessage:switch(Number(b.content.serviceStatus)){case 1:"1"==c.conversationServer._customService.type?c.changeCustomerState(a.EnumInputPanelType.robot):c.changeCustomerState(a.EnumInputPanelType.robotSwitchPerson);break;case 2:c.changeCustomerState(a.EnumInputPanelType.person);break;case 3:c.changeCustomerState(a.EnumInputPanelType.notService)}}if(d){var e=a.Message.convert(d);c.conversationServer.addCustomServiceInfo(e),c.conversationServer._addHistoryMessages(e)}c.conversationServer.addCustomServiceInfo(b),setTimeout(function(){c.$scope.$apply(),c.$scope.scrollBar()},200)}b.messageType===a.MessageType.ImageMessage&&setTimeout(function(){c.$scope.$apply(),c.$scope.scrollBar()},800)},b.prototype.changeCustomerState=function(b){this.$scope._inputPanelState=b,b==a.EnumInputPanelType.person?(this.$scope.evaluate.type=a.EnumCustomerStatus.person,this.conversationServer._customService.currentType=a.EnumCustomerStatus.person):(this.$scope.evaluate.type=a.EnumCustomerStatus.robot,this.conversationServer._customService.currentType=a.EnumCustomerStatus.robot)},b.prototype.packDisplaySendMessage=function(a,b){var c=new RongIMLib.Message,d=new RongIMLib.UserInfo(this.providerdata.currentUserInfo.userId,this.providerdata.currentUserInfo.name||"我",this.providerdata.currentUserInfo.portraitUri);return a.user=d,c.content=a,c.conversationType=this.$scope.conversation.targetType,c.targetId=this.$scope.conversation.targetId,c.senderUserId=this.providerdata.currentUserInfo.userId,c.messageDirection=RongIMLib.MessageDirection.SEND,c.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),c.messageType=b,c},b.prototype.packReceiveMessage=function(a,b){var c=new RongIMLib.Message,d=null;return a.userInfo=d,c.content=a,c.conversationType=this.$scope.conversation.targetType,c.targetId=this.$scope.conversation.targetId,c.senderUserId=this.$scope.conversation.targetId,c.messageDirection=RongIMLib.MessageDirection.RECEIVE,c.sentTime=(new Date).getTime()-(RongIMLib.RongIMClient.getInstance().getDeltaTime()||0),c.messageType=b,c},b.$inject=["$scope","ConversationServer","WebIMWidget","ConversationListServer","WidgetConfig","ProviderData","RongIMSDKServer"],b}();angular.module("RongWebIMWidget.conversation").controller("conversationController",d)}(b=a.conversation||(a.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(b){var c=a.DirectiveFactory.GetFactoryFor,d=function(){function b(a){this.conversationServer=a,this.restrict="E",this.templateUrl="./ts/conversation/conversation.tpl.html",this.controller="conversationController"}return b.prototype.link=function(b,c){window.jQuery&&window.jQuery.nicescroll&&!a.Helper.browser.msie&&$("#Messages").niceScroll({cursorcolor:"#0099ff",cursoropacitymax:1,touchbehavior:!0,cursorwidth:"8px",cursorborder:"0",cursorborderradius:"5px"}),b.scrollBar=function(){setTimeout(function(){var a=document.getElementById("Messages");a&&(a.scrollTop=a.scrollHeight)},200)}},b.$inject=["ConversationServer"],b}(),e=function(){function b(){this.restrict="E",this.scope={item:"=",content:"="},this.template='<div style="display:inline-block"></div>'}return b.prototype.link=function(b,c,d){c.find("div").append(b.item),c.on("click",function(){b.content.messageContent=b.content.messageContent||"",b.content.messageContent=b.content.messageContent.replace(/\n$/,""),b.content.messageContent=b.content.messageContent+b.item.children[0].getAttribute("name"),b.$parent.$apply();var c=document.getElementById("inputMsg");a.Helper.getFocus(c)})},b}(),f=function(){function a(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" ng-bind-html="msg.content|trustHtml"><br></pre></div></div>'}return a.prototype.link=function(a,b,c){},a}(),g=function(){function a(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" style="">维护中 由于我们的服务商出现故障，融云官网及相关服务也受到影响，给各位用户带来的不便，还请谅解。  您可以通过 <a href="#">【官方微博】</a>了解</pre></div></div>'}return a}(),h=function(){function a(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-img"><span id="{{\'rebox_\'+$id}}"  class="rongcloud-Message-entry" style=""><a href="{{msg.imageUri}}" target="_black"><img ng-src="{{msg.content}}"  data-image="{{msg.imageUri}}" alt=""/></a></span></div></div>'}return a.prototype.link=function(a,b,c){var d=new Image;d.src=a.msg.imageUri,d.onload=function(){a.$apply(function(){a.msg.content=a.msg.imageUri})},setTimeout(function(){window.jQuery&&window.jQuery.rebox&&$("#rebox_"+a.$id).rebox({selector:"a",zIndex:999999,theme:"rebox"}).bind("rebox:open",function(){var a=document.getElementsByClassName("rebox")[0];a.onclick=function(b){if("img"!=b.target.tagName.toLowerCase()){var c=document.getElementsByClassName("rebox-close")[0];c.click(),a=null,c=null}}})})},a}(),i=function(){function a(b){this.$timeout=b,this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-audio"><span class="rongcloud-Message-entry" style=""><span class="rongcloud-audioBox" ng-click="play()" ng-class="{\'rongcloud-animate\':isplaying}" ><i></i><i></i><i></i> </span><span class="rongcloud-audioTimer">{{msg.duration}}”</span> <span class="rongcloud-audioState" ng-show="msg.isUnReade"></span></span></div></div>',a.prototype.link=function(a,c,d){a.msg.duration=parseInt(a.msg.duration||a.msg.content.length/1024),RongIMLib.RongIMVoice.preLoaded(a.msg.content),a.play=function(){RongIMLib.RongIMVoice.stop(a.msg.content),a.isplaying?(a.isplaying=!1,b.cancel(a.timeoutid)):(a.msg.isUnReade=!1,RongIMLib.RongIMVoice.play(a.msg.content,a.msg.duration),a.isplaying=!0,a.timeoutid&&b.cancel(a.timeoutid),a.timeoutid=b(function(){a.isplaying=!1},1e3*a.msg.duration))}}}return a.$inject=["$timeout"],a}(),j=function(){function a(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-map"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-mapBox"><img ng-src="{{msg.content}}" alt=""><span>{{msg.poi}}</span></div></span></div></div>'}return a}(),k=function(){function a(){this.restrict="E",this.scope={msg:"="},this.template='<div class=""><div class="rongcloud-Message-image-text"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-image-textBox"><h4>{{msg.title}}</h4><div class="rongcloud-cont rongcloud-clearfix"><img ng-src="{{msg.imageUri}}" alt=""><div>{{msg.content}}</div></div></div></span></div></div>'}return a}();angular.module("RongWebIMWidget.conversation").directive("rongConversation",c(d)).directive("emoji",c(e)).directive("textmessage",c(f)).directive("includinglinkmessage",c(g)).directive("imagemessage",c(h)).directive("voicemessage",c(i)).directive("locationmessage",c(j)).directive("richcontentmessage",c(k))}(b=a.conversation||(a.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(b){var c=function(){function a(){this.human={}}return a}(),d=function(){function b(b,d){this.$q=b,this.providerdata=d,this.current=new a.Conversation,this._cacheHistory={},this._cacheCustomService={},this._customService=new c}return b.prototype.unshiftHistoryMessages=function(b,c,d){var e=c+"_"+b,f=this._cacheHistory[e]=this._cacheHistory[e]||[];f[0]&&f[0].sentTime&&f[0].panelType!=a.PanelType.Time&&d.sentTime&&(a.Helper.timeCompare(f[0].sentTime,d.sentTime)||f.unshift(new a.TimePanl(f[0].sentTime))),f.unshift(d)},b.prototype._getHistoryMessages=function(b,c,d,e){var f=this.$q.defer(),g=this;return RongIMLib.RongIMClient.getInstance().getHistoryMessages(b,c,e?0:null,d,{onSuccess:function(d,e){for(var h=d.length;h--;){var i=a.Message.convert(d[h]);switch(i.messageType){case a.MessageType.TextMessage:case a.MessageType.ImageMessage:case a.MessageType.VoiceMessage:case a.MessageType.RichContentMessage:case a.MessageType.LocationMessage:case a.MessageType.InformationNotificationMessage:g.unshiftHistoryMessages(c,b,i),g.addCustomServiceInfo(i),i.content&&g.providerdata.getUserInfo&&!function(b){g.providerdata.getUserInfo(b.senderUserId,{onSuccess:function(c){b.content.userInfo=new a.UserInfo(c.userId,c.name,c.portraitUri)}})}(i);break;case a.MessageType.UnknownMessage:}}f.resolve({data:d,has:e})},onError:function(a){f.reject(a)}}),f.promise},b.prototype._addHistoryMessages=function(b){var c=b.conversationType+"_"+b.targetId,d=this._cacheHistory[c];0==d.length&&d.push(new a.GetHistoryPanel),d[d.length-1]&&d[d.length-1].panelType!=a.PanelType.Time&&d[d.length-1].sentTime&&b.sentTime&&(a.Helper.timeCompare(d[d.length-1].sentTime,b.sentTime)||d.push(new a.TimePanl(b.sentTime))),d.push(b)},b.prototype.updateUploadToken=function(){var a=this;RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(b){a._uploadToken=b.token},onError:function(){}})},b.prototype.addCustomServiceInfo=function(b){return!b.content||b.content.userInfo&&b.content.userInfo.name?void 0:(b.conversationType==a.EnumConversationType.CUSTOMER_SERVICE&&b.content&&b.messageDirection==a.MessageDirection.RECEIVE&&1!==this._customService.currentType?b.content.userInfo={name:this._customService.robotName,portraitUri:this._customService.robotIcon}:b.conversationType==a.EnumConversationType.CUSTOMER_SERVICE&&b.content&&b.messageDirection==a.MessageDirection.SEND&&(b.content.userInfo={name:"我",portraitUri:this.providerdata.currentUserInfo.portraitUri}),b)},b.prototype.getCacheCustomService=function(b,c){if(b=Number(b),b==a.EnumConversationType.CUSTOMER_SERVICE){var d=b+"_"+c,e=this._cacheCustomService;return e[d]=e[d]||{},e[d]}},b.$inject=["$q","ProviderData"],b}();angular.module("RongWebIMWidget.conversation").service("ConversationServer",d)}(b=a.conversation||(a.conversation={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(a){var b=function(){function a(a,b,c){this.$scope=a,this.conversationListServer=b,this.WebIMWidget=c,a.minbtn=function(){c.display=!1},a.conversationListServer=b}return a.$inject=["$scope","ConversationListServer","WebIMWidget"],a}();angular.module("RongWebIMWidget.conversationlist").controller("conversationListController",b)}(b=a.conversationlist||(a.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(b){var c=a.DirectiveFactory.GetFactoryFor,d=function(){function b(c,d,e){this.conversationServer=c,this.conversationListServer=d,this.RongIMSDKServer=e,this.restrict="E",this.scope={item:"="},this.template='<div class="rongcloud-chatList"><div class="rongcloud-chat_item " ng-class="{\'rongcloud-online\':item.onLine}"><div class="rongcloud-ext"><p class="rongcloud-attr clearfix"><span class="rongcloud-badge" ng-show="item.unreadMessageCount>0">{{item.unreadMessageCount>99?"99+":item.unreadMessageCount}}</span><i class="rongcloud-sprite rongcloud-no-remind" ng-click="remove($event)"></i></p></div><div class="rongcloud-photo"><img class="rongcloud-img" ng-src="{{item.portraitUri}}" err-src="http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png" alt=""><i ng-show="!!$parent.data.getOnlineStatus&&item.targetType==1" class="rongcloud-Presence rongcloud-Presence--stacked rongcloud-Presence--mainBox"></i></div><div class="rongcloud-info"><h3 class="rongcloud-nickname"><span class="rongcloud-nickname_text" title="{{item.title}}">{{item.title}}</span></h3></div></div></div>',b.prototype.link=function(b,f,g){f.on("click",function(){c.changeConversation(new a.Conversation(b.item.targetType,b.item.targetId,b.item.title)),b.item.unreadMessageCount>0&&(e.clearUnreadCount(b.item.targetType,b.item.targetId),e.sendReadReceiptMessage(b.item.targetId,Number(b.item.targetType)),d.updateConversations())}),b.remove=function(a){a.stopPropagation(),e.removeConversation(b.item.targetType,b.item.targetId).then(function(){c.current.targetType==b.item.targetType&&c.current.targetId==b.item.targetId,d.updateConversations()},function(a){})}}}return b.$inject=["ConversationServer","ConversationListServer","RongIMSDKServer"],b}();angular.module("RongWebIMWidget.conversationlist").directive("rongConversationList",["WebIMWidget",function(a){return{restrict:"E",templateUrl:"./ts/conversationlist/conversationList.tpl.html",controller:"conversationListController",link:function(){a.isReady=!0,a.onReady&&a.onReady()}}}]).directive("conversationItem",c(d))}(b=a.conversationlist||(a.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(b){var c=function(){function b(a,b,c,d,e){this.$q=a,this.providerdata=b,this.widgetConfig=c,this.RongIMSDKServer=d,this.conversationServer=e,this._conversationList=[],this._onlineStatus=[],this.hiddenConversations=[],this._hiddenConversationObject={}}return b.prototype.setHiddenConversations=function(a){if(angular.isArray(a))for(var b=0,c=a.length;c>b;b++)this._hiddenConversationObject[a[b].type+"_"+a[b].id]=!0},b.prototype.updateConversations=function(){var b=this.$q.defer(),c=this;return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(d){var e=0;c._conversationList.splice(0,c._conversationList.length);for(var f=0,g=d.length;g>f;f++){var h=a.Conversation.onvert(d[f]);if(!c._hiddenConversationObject[h.targetType+"_"+h.targetId]){switch(h.targetType){case RongIMLib.ConversationType.PRIVATE:"function"==a.Helper.checkType(c.providerdata.getUserInfo)&&!function(a,b){
c.providerdata.getUserInfo(a.targetId,{onSuccess:function(c){a.title=c.name,a.portraitUri=c.portraitUri,b.conversationTitle=c.name,b.portraitUri=c.portraitUri}})}(h,d[f]);break;case RongIMLib.ConversationType.GROUP:"function"==a.Helper.checkType(c.providerdata.getGroupInfo)&&!function(a,b){c.providerdata.getGroupInfo(a.targetId,{onSuccess:function(c){a.title=c.name,a.portraitUri=c.portraitUri,b.conversationTitle=c.name,b.portraitUri=c.portraitUri}})}(h,d[f]);break;case RongIMLib.ConversationType.CUSTOMER_SERVICE:h.title="客服";break;case RongIMLib.ConversationType.CHATROOM:h.title="聊天室："+h.targetId}e+=Number(h.unreadMessageCount)||0,c._conversationList.push(h)}}if(c._onlineStatus.forEach(function(b){var d=c._getConversation(a.EnumConversationType.PRIVATE,b.id);d&&(d.onLine=b.status)}),c.widgetConfig.displayConversationList)c.providerdata.totalUnreadCount=e,b.resolve();else{var i=c.conversationServer.current;i&&i.targetId&&c.RongIMSDKServer.getConversation(i.targetType,i.targetId).then(function(a){a&&a.unreadMessageCount?(c.providerdata.totalUnreadCount=a.unreadMessageCount||0,b.resolve()):(c.providerdata.totalUnreadCount=0,b.resolve())})}},onError:function(a){b.reject(a)}},null),b.promise},b.prototype._getConversation=function(a,b){for(var c=0,d=this._conversationList.length;d>c;c++)if(this._conversationList[c].targetType==a&&this._conversationList[c].targetId==b)return this._conversationList[c];return null},b.prototype.startRefreshOnlineStatus=function(){var a=this;a.widgetConfig.displayConversationList&&a.providerdata.getOnlineStatus&&(a._getOnlineStatus(),a.__intervale&&clearInterval(this.__intervale),a.__intervale=setInterval(function(){a._getOnlineStatus()},3e4))},b.prototype._getOnlineStatus=function(){var a=this,b=a._conversationList.map(function(a){return a.targetId});a.providerdata.getOnlineStatus(b,{onSuccess:function(b){a._onlineStatus=b,a.updateConversations()}})},b.prototype.stopRefreshOnlineStatus=function(){clearInterval(this.__intervale),this.__intervale=null},b.$inject=["$q","ProviderData","WidgetConfig","RongIMSDKServer","ConversationServer"],b}();angular.module("RongWebIMWidget.conversationlist").service("ConversationListServer",c)}(b=a.conversationlist||(a.conversationlist={}))}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b=(function(){function a(){}return a}(),195),c=50,d=195,e=3,f=function(){function f(b,c,d,e,f,g,h){this.$q=b,this.conversationServer=c,this.conversationListServer=d,this.providerdata=e,this.widgetConfig=f,this.RongIMSDKServer=g,this.$log=h,this.display=!1,this.connected=!1,this.isReady=!1,this.isInit=!1,this.EnumConversationType=a.EnumConversationType,this.EnumConversationListPosition=a.EnumConversationListPosition}return f.prototype.initStyle=function(f){var g=this,h=document.getElementById("rong-conversation"),i=document.getElementById("rong-conversation-list"),j=document.getElementById("rong-widget-minbtn");if(g.widgetConfig.__isKefu&&(j=document.getElementById("rong-widget-minbtn-kefu")),f)if(h.style.height=f.height+"px",h.style.width=f.width+"px",i.style.height=f.height+"px",f.positionFixed?(i.style.position="fixed",j.style.position="fixed",h.style.position="fixed"):(i.style.position="absolute",j.style.position="absolute",h.style.position="absolute"),g.widgetConfig.displayConversationList){if(j.style.display="inline-block",i.style.display="inline-block",g.widgetConfig.conversationListPosition==a.EnumConversationListPosition.left)isNaN(f.left)||(i.style.left=f.left+"px",j.style.left=f.left+"px",h.style.left=f.left+b+e+"px"),isNaN(f.right)||(i.style.right=f.right+f.width+e+"px",j.style.right=f.right+f.width+e+"px",h.style.right=f.right+"px");else{if(g.widgetConfig.conversationListPosition!=a.EnumConversationListPosition.right)throw new Error("config conversationListPosition value is invalid");isNaN(f.left)||(i.style.left=f.left+f.width+e+"px",j.style.left=f.left+f.width+e+"px",h.style.left=f.left+"px"),isNaN(f.right)||(i.style.right=f.right+"px",j.style.right=f.right+"px",h.style.right=f.right+b+e+"px")}isNaN(f.top)||(i.style.top=f.top+"px",j.style.top=f.top+f.height-c+"px",h.style.top=f.top+"px"),isNaN(f.bottom)||(i.style.bottom=f.bottom+"px",j.style.bottom=f.bottom+"px",h.style.bottom=f.bottom+"px")}else j.style.display="inline-block",i.style.display="none",h.style.left=f.left+"px",h.style.right=f.right+"px",h.style.top=f.top+"px",h.style.bottom=f.bottom+"px",j.style.top=f.top+f.height-c+"px",j.style.bottom=f.bottom+"px",j.style.left=f.left+f.width/2-d/2+"px",j.style.right=f.right+f.width/2-d/2+"px";0==g.widgetConfig.displayMinButton?j.style.display="none":j.style.display="block"},f.prototype.init=function(b){var c=this;if(this.isInit=!0,b.reminder&&(c.widgetConfig.reminder=b.reminder),!window.RongIMLib||!window.RongIMLib.RongIMClient)return void(c.widgetConfig._config=b);var d=c.widgetConfig.style;angular.extend(c.widgetConfig,b),c.widgetConfig.style=angular.extend(d,b.style),b.desktopNotification&&a.NotificationHelper.requestPermission();var e=document.getElementById("rongcloud-playsound");e&&"string"==typeof c.widgetConfig.voiceUrl?(e.src=c.widgetConfig.voiceUrl,c.widgetConfig.voiceNotification=!0):c.widgetConfig.voiceNotification=!1,this.isReady?c.initStyle(d):c.onReady=function(){c.initStyle(d)},c.conversationListServer.setHiddenConversations(c.widgetConfig.hiddenConversations),c.RongIMSDKServer.init(c.widgetConfig.appkey),RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.init(),RongIMLib.RongIMVoice&&RongIMLib.RongIMVoice.init(),c.RongIMSDKServer.registerMessage(),c.RongIMSDKServer.connect(c.widgetConfig.token).then(function(b){c.conversationListServer.updateConversations(),c.conversationListServer.startRefreshOnlineStatus(),c.conversationServer._handleConnectSuccess&&c.conversationServer._handleConnectSuccess(),"function"==a.Helper.checkType(c.widgetConfig.onSuccess)&&c.widgetConfig.onSuccess(b),"function"==a.Helper.checkType(c.providerdata.getUserInfo)&&c.providerdata.getUserInfo(b,{onSuccess:function(b){c.providerdata.currentUserInfo=new a.UserInfo(b.userId,b.name,b.portraitUri)}})},function(a){a.tokenError?c.widgetConfig.onError&&"function"==typeof c.widgetConfig.onError&&c.widgetConfig.onError({code:0,info:"token 无效"}):c.widgetConfig.onError&&"function"==typeof c.widgetConfig.onError&&c.widgetConfig.onError({code:a.errorCode})}),c.RongIMSDKServer.setConnectionStatusListener({onChanged:function(a){switch(c.providerdata.connectionState=!1,a){case RongIMLib.ConnectionStatus.CONNECTED:c.$log.debug("链接成功"),c.providerdata.connectionState=!0;break;case RongIMLib.ConnectionStatus.CONNECTING:c.$log.debug("正在链接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:c.$log.debug("其他设备登录");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:c.$log.debug("网络不可用");break;default:c.$log.debug(a)}}}),c.RongIMSDKServer.setOnReceiveMessageListener({onReceived:function(b){c.$log.debug(b);var d=a.Message.convert(b);switch("function"==a.Helper.checkType(c.providerdata.getUserInfo)&&d.content&&!b.content.user&&c.providerdata.getUserInfo(d.senderUserId,{onSuccess:function(b){b&&(d.content.userInfo=new a.UserInfo(b.userId,b.name,b.portraitUri))}}),b.messageType){case a.MessageType.VoiceMessage:d.content.isUnReade=!0;case a.MessageType.TextMessage:case a.MessageType.LocationMessage:case a.MessageType.ImageMessage:case a.MessageType.RichContentMessage:c.addMessageAndOperation(d);var f=1==c.providerdata.voiceSound&&e&&b.messageDirection==a.MessageDirection.RECEIVE&&c.widgetConfig.voiceNotification,g=c.conversationServer.current&&c.conversationServer.current.targetType==d.conversationType&&c.conversationServer.current.targetId==d.targetId,h=(document.hidden||!c.display)&&b.messageDirection==a.MessageDirection.RECEIVE&&c.widgetConfig.desktopNotification;(c.widgetConfig.displayConversationList&&f||!c.widgetConfig.displayConversationList&&f&&g)&&e.play(),(h&&c.widgetConfig.displayConversationList||!c.widgetConfig.displayConversationList&&h&&g)&&a.NotificationHelper.showNotification({title:d.content.userInfo.name,icon:"",body:a.Message.messageToNotification(b),data:{targetId:d.targetId,targetType:d.conversationType}});break;case a.MessageType.ContactNotificationMessage:break;case a.MessageType.InformationNotificationMessage:c.addMessageAndOperation(d);break;case a.MessageType.UnknownMessage:break;case a.MessageType.ReadReceiptMessage:b.messageDirection==a.MessageDirection.SEND&&c.RongIMSDKServer.clearUnreadCount(b.conversationType,b.targetId);break;case"HandShakeResponseMessage":c.HandShakeResponseMessage(b);break;case"ChangeModeResponseMessage":c.ChangeModeResponseMessage(b);break;case"TerminateMessage":c.TerminateMessage(b);break;case"CustomerStatusUpdateMessage":c.CustomerStatusUpdateMessage(b)}c.onReceivedMessage&&c.onReceivedMessage(b),c.conversationServer.handleMessage(d),!document.hidden&&c.display&&c.conversationServer.current&&c.conversationServer.current.targetType==d.conversationType&&c.conversationServer.current.targetId==d.targetId&&b.messageDirection==a.MessageDirection.RECEIVE&&b.messageType!=a.MessageType.ReadReceiptMessage&&(c.RongIMSDKServer.clearUnreadCount(c.conversationServer.current.targetType,c.conversationServer.current.targetId),c.RongIMSDKServer.sendReadReceiptMessage(c.conversationServer.current.targetId,c.conversationServer.current.targetType)),c.conversationListServer.updateConversations().then(function(){})}}),window.onfocus=function(){c.conversationServer.current&&c.conversationServer.current.targetId&&c.display&&c.RongIMSDKServer.getConversation(c.conversationServer.current.targetType,c.conversationServer.current.targetId).then(function(a){a&&a.unreadMessageCount>0&&(c.RongIMSDKServer.clearUnreadCount(c.conversationServer.current.targetType,c.conversationServer.current.targetId),c.RongIMSDKServer.sendReadReceiptMessage(c.conversationServer.current.targetId,c.conversationServer.current.targetType),c.conversationListServer.updateConversations().then(function(){}))})}},f.prototype.HandShakeResponseMessage=function(b){var c=b.conversationType,d=b.targetId,e=this.conversationServer.getCacheCustomService(c,d);e&&(angular.merge(e,b.content.data),e.connected=!0,"1"==b.content.data.serviceType?e.inputPanelState=a.EnumInputPanelType.robot:"3"==b.content.data.serviceType?e.inputPanelState=a.EnumInputPanelType.robotSwitchPerson:e.inputPanelState=a.EnumInputPanelType.person)},f.prototype.ChangeModeResponseMessage=function(b){var c=b.conversationType,d=b.targetId,e=this.conversationServer.getCacheCustomService(c,d);if(e)switch(b.content.data.status){case 1:e.inputPanelState=a.EnumInputPanelType.person;break;case 2:"2"==e.type?e.inputPanelState=a.EnumInputPanelType.person:"1"!=e.type&&"3"!=e.type||(e.inputPanelState=a.EnumInputPanelType.robotSwitchPerson);break;case 3:e.inputPanelState=a.EnumInputPanelType.robot;break;case 4:e.inputPanelState=a.EnumInputPanelType.person}},f.prototype.TerminateMessage=function(b){var c=b.conversationType,d=b.targetId,e=this.conversationServer.getCacheCustomService(c,d);e.connected=!1,e&&0!=b.content.code&&("1"==e.type?e.inputPanelState=a.EnumInputPanelType.robot:e.inputPanelState=a.EnumInputPanelType.robotSwitchPerson)},f.prototype.CustomerStatusUpdateMessage=function(b){var c=b.conversationType,d=b.targetId,e=this.conversationServer.getCacheCustomService(c,d);if(e)switch(Number(b.content.serviceStatus)){case 1:"1"==e.type?e.inputPanelState=a.EnumInputPanelType.robot:e.inputPanelState=a.EnumInputPanelType.robotSwitchPerson;break;case 2:e.inputPanelState=a.EnumInputPanelType.person;break;case 3:e.inputPanelState=a.EnumInputPanelType.notService}},f.prototype.addMessageAndOperation=function(b){if(b.conversationType!==a.EnumConversationType.CUSTOMER_SERVICE||this.conversationServer._customService.connected){var c=b.conversationType+"_"+b.targetId,d=this.conversationServer._cacheHistory[c]=this.conversationServer._cacheHistory[c]||[];0==d.length&&(d.push(new a.GetHistoryPanel),d.push(new a.TimePanl(b.sentTime))),this.conversationServer._addHistoryMessages(b)}},f.prototype.setConversation=function(b,c,d){this.conversationServer.changeConversation(new a.Conversation(b,c,d))},f.prototype.setUserInfoProvider=function(a){this.providerdata.getUserInfo=a},f.prototype.setGroupInfoProvider=function(a){this.providerdata.getGroupInfo=a},f.prototype.setOnlineStatusProvider=function(a){this.providerdata.getOnlineStatus=a},f.prototype.setProductInfo=function(a){this.conversationServer._customService.connected?this.RongIMSDKServer.sendProductInfo(this.conversationServer.current.targetId,a):this.providerdata._productInfo=a},f.prototype.show=function(){this.display=!0},f.prototype.hidden=function(){this.display=!1},f.prototype.getCurrentConversation=function(){return this.conversationServer.current},f.$inject=["$q","ConversationServer","ConversationListServer","ProviderData","WidgetConfig","RongIMSDKServer","$log"],f}();a.WebIMWidget=f,angular.module("RongWebIMWidget").service("WebIMWidget",f)}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b;!function(a){a[a.left=1]="left",a[a.right=2]="right"}(b||(b={}));var c=function(){function c(a){this.WebIMWidget=a,this.defaultconfig={__isCustomerService:!0},this.Position=b}return c.prototype.init=function(c){var d=this;angular.extend(this.defaultconfig,c);var e={right:20};c.position&&(e=c.position==b.left?{left:20,bottom:0,width:325,positionFixed:!0}:{right:20,bottom:0,width:325,positionFixed:!0}),c.style&&(c.style.width&&(e.width=c.style.width),c.style.height&&(e.height=c.style.height)),this.defaultconfig.style=e,d.WebIMWidget.init(this.defaultconfig),d.WebIMWidget.onShow=function(){d.WebIMWidget.setConversation(a.EnumConversationType.CUSTOMER_SERVICE,c.customerServiceId,"客服")}},c.prototype.show=function(){this.WebIMWidget.show()},c.prototype.setProductInfo=function(a){this.WebIMWidget.setProductInfo(a)},c.prototype.hidden=function(){this.WebIMWidget.hidden()},c.$inject=["WebIMWidget"],c}();a.RongCustomerService=c,angular.module("RongWebIMWidget").service("RongCustomerService",c)}(RongWebIMWidget||(RongWebIMWidget={}));var Evaluate;!function(a){var b=function(){function a(b){this.$timeout=b,this.restrict="E",this.scope={type:"=",display:"=",enter:"&confirm",dcancle:"&cancle"},this.templateUrl="./ts/evaluate/evaluate.tpl.html",a.prototype.link=function(a,c){function d(c){a.end=!0,c?b(function(){a.display=!1,a.end=!1,a.enter({data:c})},800):(a.display=!1,a.end=!1,a.enter({data:c}))}var e=[!1,!1,!1,!1,!1],f=[{display:"答非所问"},{display:"理解能力差"},{display:"一问三不知"},{display:"不礼貌"}],g=!1;a.stars=e,a.labels=RongWebIMWidget.Helper.cloneObject(f),a.end=!1,a.displayDescribe=!1,a.data={stars:0,value:0,describe:"",label:""},a.$watch("display",function(b,c){b!==c&&(g=!1,a.displayDescribe=!1,a.labels=RongWebIMWidget.Helper.cloneObject(f),a.data={stars:0,value:0,describe:"",label:""})}),a.mousehover=function(b){!g&&(a.data.stars=b)},a.confirm=function(b){void 0!=b?(g=!0,1==a.type?(a.data.stars=b,5!=a.data.stars?a.displayDescribe=!0:d(a.data)):(a.data.value=b,a.data.value===!1?a.displayDescribe=!0:d(a.data))):d(null)},a.commit=function(){for(var b=[],c=0,e=a.labels.length;e>c;c++)a.labels[c].selected&&b.push(a.labels[c].display);a.data.label=b,d(a.data)},a.cancle=function(){a.display=!1,a.dcancle()}}}return a.$inject=["$timeout"],a}();angular.module("Evaluate",[]).directive("evaluatedir",RongWebIMWidget.DirectiveFactory.GetFactoryFor(b))}(Evaluate||(Evaluate={}));var RongWebIMWidget;!function(a){function b(a,b,c,d){}b.$inject=["$http","WebIMWidget","WidgetConfig","RongCustomerService"];var c=function(){function a(){this.restrict="E",this.templateUrl="./ts/main.tpl.html",this.controller="rongWidgetController"}return a}(),d=function(){function b(b,c,d,e,f,g,h,i){this.$scope=b,this.$interval=c,this.WebIMWidget=d,this.WidgetConfig=e,this.providerdata=f,this.conversationServer=g,this.conversationListServer=h,this.RongIMSDKServer=i,b.main=d,b.config=e,b.data=f;var j=a.Helper.CookieHelper.getCookie("rongcloud.voiceSound");f.voiceSound=j?"true"==j:!0,b.$watch("data.voiceSound",function(b,c){b!==c&&a.Helper.CookieHelper.setCookie("rongcloud.voiceSound",b)});var k=null;b.$watch("data.totalUnreadCount",function(a,d){a>0?(k&&c.cancel(k),k=c(function(){b.twinkle=!b.twinkle},1e3)):c.cancel(k)}),b.$watch("main.display",function(){g.current&&g.current.targetId&&d.display&&i.getConversation(g.current.targetType,g.current.targetId).then(function(a){a&&a.unreadMessageCount>0&&(i.clearUnreadCount(g.current.targetType,g.current.targetId),i.sendReadReceiptMessage(g.current.targetId,g.current.targetType),h.updateConversations().then(function(){}))})}),d.show=function(){d.display=!0,d.fullScreen=!1,d.onShow&&d.onShow(),setTimeout(function(){b.$apply()})},d.hidden=function(){d.display=!1,setTimeout(function(){b.$apply()})},b.showbtn=function(){d.display=!0,d.onShow&&d.onShow()}}return b.$inject=["$scope","$interval","WebIMWidget","WidgetConfig","ProviderData","ConversationServer","ConversationListServer","RongIMSDKServer"],b}();angular.module("RongWebIMWidget").run(b).directive("rongWidget",a.DirectiveFactory.GetFactoryFor(c)).controller("rongWidgetController",d)}(RongWebIMWidget||(RongWebIMWidget={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},RongWebIMWidget;!function(a){!function(a){a[a.left=0]="left",a[a.right=1]="right"}(a.EnumConversationListPosition||(a.EnumConversationListPosition={}));a.EnumConversationListPosition;!function(a){a[a.PRIVATE=1]="PRIVATE",a[a.DISCUSSION=2]="DISCUSSION",a[a.GROUP=3]="GROUP",a[a.CHATROOM=4]="CHATROOM",a[a.CUSTOMER_SERVICE=5]="CUSTOMER_SERVICE",a[a.SYSTEM=6]="SYSTEM",a[a.APP_PUBLIC_SERVICE=7]="APP_PUBLIC_SERVICE",a[a.PUBLIC_SERVICE=8]="PUBLIC_SERVICE"}(a.EnumConversationType||(a.EnumConversationType={}));a.EnumConversationType;!function(a){a[a.SEND=1]="SEND",a[a.RECEIVE=2]="RECEIVE"}(a.MessageDirection||(a.MessageDirection={}));a.MessageDirection;!function(a){a[a.READ=1]="READ",a[a.LISTENED=2]="LISTENED",a[a.DOWNLOADED=4]="DOWNLOADED"}(a.ReceivedStatus||(a.ReceivedStatus={}));a.ReceivedStatus;!function(a){a[a.SENDING=10]="SENDING",a[a.FAILED=20]="FAILED",a[a.SENT=30]="SENT",a[a.RECEIVED=40]="RECEIVED",a[a.READ=50]="READ",a[a.DESTROYED=60]="DESTROYED"}(a.SentStatus||(a.SentStatus={}));var b;a.SentStatus;!function(a){a[a.left=1]="left",a[a.right=2]="right",a[a.top=3]="top",a[a.bottom=4]="bottom"}(b||(b={})),function(a){a[a.person=0]="person",a[a.robot=1]="robot",a[a.robotSwitchPerson=2]="robotSwitchPerson",a[a.notService=4]="notService"}(a.EnumInputPanelType||(a.EnumInputPanelType={}));a.EnumInputPanelType;!function(a){a[a.person=1]="person",a[a.robot=2]="robot"}(a.EnumCustomerStatus||(a.EnumCustomerStatus={}));a.EnumCustomerStatus;a.MessageType={DiscussionNotificationMessage:"DiscussionNotificationMessage ",TextMessage:"TextMessage",ImageMessage:"ImageMessage",VoiceMessage:"VoiceMessage",RichContentMessage:"RichContentMessage",HandshakeMessage:"HandshakeMessage",UnknownMessage:"UnknownMessage",SuspendMessage:"SuspendMessage",LocationMessage:"LocationMessage",InformationNotificationMessage:"InformationNotificationMessage",ContactNotificationMessage:"ContactNotificationMessage",ProfileNotificationMessage:"ProfileNotificationMessage",CommandNotificationMessage:"CommandNotificationMessage",HandShakeResponseMessage:"HandShakeResponseMessage",ChangeModeResponseMessage:"ChangeModeResponseMessage",TerminateMessage:"TerminateMessage",CustomerStatusUpdateMessage:"CustomerStatusUpdateMessage",ReadReceiptMessage:"ReadReceiptMessage"},function(a){a[a.Message=1]="Message",a[a.InformationNotification=2]="InformationNotification",a[a.System=103]="System",a[a.Time=104]="Time",a[a.getHistory=105]="getHistory",a[a.getMore=106]="getMore",a[a.Other=0]="Other"}(a.PanelType||(a.PanelType={}));var c=a.PanelType,d=function(){function a(a){this.panelType=a}return a}();a.ChatPanel=d;var e=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanl=e;var f=function(a){function b(){a.call(this,c.getHistory)}return __extends(b,a),b}(d);a.GetHistoryPanel=f;var g=function(a){function b(){a.call(this,c.getMore)}return __extends(b,a),b}(d);a.GetMoreMessagePanel=g;var h=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanel=h;var i=function(b){function d(a,d,e,f,g,h,i,j,k,l,m,n,o){b.call(this,c.Message)}return __extends(d,b),d.convert=function(b){var c=new d;switch(c.conversationType=b.conversationType,c.extra=b.extra,c.objectName=b.objectName,c.messageDirection=b.messageDirection,c.messageId=b.messageId,c.receivedStatus=b.receivedStatus,c.receivedTime=new Date(b.receivedTime),c.senderUserId=b.senderUserId,c.sentStatus=b.sendStatusMessage,c.sentTime=new Date(b.sentTime),c.targetId=b.targetId,c.messageType=b.messageType,c.messageType){case a.MessageType.TextMessage:var e=new l,f=b.content.content;f=a.Helper.escapeSymbol.encodeHtmlsymbol(f),f=a.Helper.discernUrlEmailInStr(f),RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.emojiToHTML&&(f=RongIMLib.RongIMEmoji.emojiToHTML(f)),e.content=f,e.extra=b.content.extra,c.content=e;break;case a.MessageType.ImageMessage:var g=new r,f=b.content.content||"";-1==f.indexOf("base64,")&&(f="data:image/png;base64,"+f),g.content=f,g.imageUri=b.content.imageUri,g.extra=b.content.extra,c.content=g;break;case a.MessageType.VoiceMessage:var h=new s;h.content=b.content.content,h.duration=b.content.duration,h.extra=b.content.extra,c.content=h;break;case a.MessageType.RichContentMessage:var i=new u;i.content=b.content.content,i.title=b.content.title,i.imageUri=b.content.imageUri,i.extra=b.content.extra,c.content=i;break;case a.MessageType.LocationMessage:var j=new t,f=b.content.content||"";-1==f.indexOf("base64,")&&(f="data:image/png;base64,"+f),j.content=f,j.latiude=b.content.latiude,j.longitude=b.content.longitude,j.poi=b.content.poi,j.extra=b.content.extra,c.content=j;break;case a.MessageType.InformationNotificationMessage:var k=new q;c.panelType=2,k.content=b.content.message,c.content=k;break;case a.MessageType.DiscussionNotificationMessage:var w=new v;w.extension=b.content.extension,w.operation=b.content.operation,w.type=b.content.type,w.isHasReceived=b.content.isHasReceived,c.content=w;case a.MessageType.HandShakeResponseMessage:var x=new m;x.status=b.content.status,x.msg=b.content.msg,x.data=b.content.data,c.content=x;break;case a.MessageType.ChangeModeResponseMessage:var y=new n;y.code=b.content.code,y.data=b.content.data,y.status=b.content.status,c.content=y;break;case a.MessageType.CustomerStatusUpdateMessage:var z=new p;z.serviceStatus=b.content.serviceStatus,c.content=z;break;case a.MessageType.TerminateMessage:var A=new o;A.code=b.content.code,c.content=A}return c.content&&(c.content.userInfo=b.content.user),c},d.messageToNotification=function(b){if(!b)return null;var c,d=b.messageType;if(d==a.MessageType.ImageMessage)c="[图片]";else if(d==a.MessageType.LocationMessage)c="[位置]";else if(d==a.MessageType.VoiceMessage)c="[语音]";else if(d==a.MessageType.ContactNotificationMessage||d==a.MessageType.CommandNotificationMessage)c="[通知消息]";else if("RC:GrpNtf"==b.objectName){var e=b.content.message.content.data.data;switch(b.content.message.content.operation){case"Add":c=e.targetUserDisplayNames?e.targetUserDisplayNames.join("、")+" 加入了群组":"加入群组";break;case"Quit":c=e.operatorNickname+" 退出了群组";break;case"Kicked":c=e.targetUserDisplayNames?e.targetUserDisplayNames.join("、")+" 被剔出群组":"移除群组";break;case"Rename":c=e.operatorNickname+" 修改了群名称";break;case"Create":c=e.operatorNickname+" 创建了群组";break;case"Dismiss":c=e.operatorNickname+" 解散了群组 "+e.targetGroupName}}else c=b.content?b.content.content:"",c=RongIMLib.RongIMEmoji.emojiToSymbol(c),c=c.replace(/\n/g," "),c=c.replace(/([\w]{49,50})/g,"$1 ");return c},d}(d);a.Message=i;var j=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.UserInfo=j;var k=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.GroupInfo=k;var l=function(){function a(a){a=a||{},this.content=a.content,this.userInfo=a.userInfo}return a}();a.TextMessage=l;var m=function(){function a(){}return a}();a.HandShakeResponseMessage=m;var n=function(){function a(){}return a}();a.ChangeModeResponseMessage=n;var o=function(){function a(){}return a}();a.TerminateMessage=o;var p=function(){function a(){}return a}();a.CustomerStatusUpdateMessage=p;var q=function(){function a(){}return a}();a.InformationNotificationMessage=q;var r=function(){function a(){}return a}();a.ImageMessage=r;var s=function(){function a(){}return a}();a.VoiceMessage=s;var t=function(){function a(){}return a}();a.LocationMessage=t;var u=function(){function a(){}return a}();a.RichContentMessage=u;var v=function(){function a(){}return a}();a.DiscussionNotificationMessage=v;var w=function(){function a(a,b,c){this.targetType=a,this.targetId=b,this.title=c||""}return a.onvert=function(b){var c=new a;return c.targetId=b.targetId,c.targetType=b.conversationType,c.title=b.conversationTitle,c.portraitUri=b.senderPortraitUri,c.unreadMessageCount=b.unreadMessageCount,c},a}();a.Conversation=w}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b=function(){function a(a){var b=this;this.$q=a,this.connect=function(a){var c=b.$q.defer();return RongIMLib.RongIMClient.connect(a,{onSuccess:function(a){c.resolve(a)},onTokenIncorrect:function(){c.reject({tokenError:!0})},onError:function(a){c.reject({errorCode:a});var b="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:b="连接超时";break;case RongIMLib.ErrorCode.UNKNOWN:b="未知错误";break;case RongIMLib.ConnectionState.UNACCEPTABLE_PROTOCOL_VERSION:b="不可接受的协议版本";break;case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:b="appkey不正确";break;case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:b="服务器不可用";break;case RongIMLib.ConnectionState.NOT_AUTHORIZED:b="未认证";break;case RongIMLib.ConnectionState.REDIRECT:b="重新获取导航";break;case RongIMLib.ConnectionState.APP_BLOCK_OR_DELETE:b="应用已被封禁或已被删除";break;case RongIMLib.ConnectionState.BLOCK:b="用户被封禁"}console.log("失败:"+b+a)}}),c.promise},this.getConversation=function(a,c){var d=b.$q.defer();return RongIMLib.RongIMClient.getInstance().getConversation(Number(a),c,{onSuccess:function(a){d.resolve(a)},onError:function(){d.reject()}}),d.promise},this.getFileToken=function(){var a=b.$q.defer();return RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(b){b?a.resolve(b.token):a.reject()},onError:function(){a.reject()}}),a.promise}}return a.prototype.init=function(a){RongIMLib.RongIMClient.init(a)},a.prototype.setOnReceiveMessageListener=function(a){RongIMLib.RongIMClient.setOnReceiveMessageListener(a)},a.prototype.setConnectionStatusListener=function(a){RongIMLib.RongIMClient.setConnectionStatusListener(a)},a.prototype.startCustomService=function(a){var b=this.$q.defer();return RongIMLib.RongIMClient.getInstance().startCustomService(a,{onSuccess:function(){b.resolve()},onError:function(){b.reject()}}),b.promise},a.prototype.sendReadReceiptMessage=function(a,b){var c=this;RongIMLib.RongIMClient.getInstance().getConversation(Number(b),a,{onSuccess:function(d){if(d){var e=RongIMLib.ReadReceiptMessage.obtain(d.latestMessage.messageUId,d.latestMessage.sentTime,"1");c.sendMessage(b,a,e)}},onError:function(){}})},a.prototype.sendMessage=function(a,b,c){var d=this.$q.defer();return RongIMLib.RongIMClient.getInstance().sendMessage(+a,b,c,{onSuccess:function(a){d.resolve(a)},onError:function(a,b){d.reject({errorCode:a,message:b});var c="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:c="超时";break;case RongIMLib.ErrorCode.UNKNOWN:c="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:c="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:c="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:c="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:c="不在聊天室中";break;default:c=""}console.log("发送失败:"+c)}}),d.promise},a.prototype.evaluateHumanCustomService=function(a,b,c){var d=this.$q.defer();return RongIMLib.RongIMClient.getInstance().evaluateHumanCustomService(a,b,c,{onSuccess:function(){d.resolve()},onError:function(){d.reject()}}),d.promise},a.prototype.evaluateRebotCustomService=function(a,b,c){var d=this.$q.defer();return RongIMLib.RongIMClient.getInstance().evaluateRebotCustomService(a,b,c,{onSuccess:function(){d.resolve()},onError:function(){d.reject()}}),d.promise},a.prototype.reconnect=function(a){RongIMLib.RongIMClient.reconnect(a)},a.prototype.disconnect=function(){RongIMLib.RongIMClient.getInstance().disconnect()},a.prototype.logout=function(){RongIMLib&&RongIMLib.RongIMClient&&RongIMLib.RongIMClient.getInstance().logout()},a.prototype.clearUnreadCount=function(a,b){var c=this.$q.defer();return RongIMLib.RongIMClient.getInstance().clearUnreadCount(a,b,{onSuccess:function(a){c.resolve(a)},onError:function(a){c.reject(a)}}),c.promise},a.prototype.getTotalUnreadCount=function(){var a=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(b){a.resolve(b)},onError:function(){a.reject()}}),a.promise},a.prototype.getConversationList=function(){var a=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(b){a.resolve(b)},onError:function(b){a.reject(b)}},null),a.promise},a.prototype.removeConversation=function(a,b){var c=this.$q.defer();return RongIMLib.RongIMClient.getInstance().removeConversation(a,b,{onSuccess:function(a){c.resolve(a)},onError:function(a){c.reject(a)}}),c.promise},a.prototype.getHistoryMessages=function(a,b,c){var d=this.$q.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(a,b,null,c,{onSuccess:function(a,b){d.resolve({data:a,has:b})},onError:function(a){d.reject(a)}}),d.promise},a.prototype.getDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().getTextMessageDraft(a,b)||""},a.prototype.setDraft=function(a,b,c){return RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(a,b,c)},a.prototype.clearDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().clearTextMessageDraft(a,b)},a.prototype.sendProductInfo=function(a,b){var c=new RongIMLib.RongIMClient.RegisterMessage.ProductMessage(b);this.sendMessage(RongIMLib.ConversationType.CUSTOMER_SERVICE,a,c)},a.prototype.registerMessage=function(){var a="ProductMessage",b="cs:product",c=new RongIMLib.MessageTag(!0,!0),d=["title","url","content","imageUrl","extra"];RongIMLib.RongIMClient.registerMessageType(a,b,c,d)},a.$inject=["$q"],a}();a.RongIMSDKServer=b,angular.module("RongWebIMWidget").service("RongIMSDKServer",b)}(RongWebIMWidget||(RongWebIMWidget={}));var RongWebIMWidget;!function(a){var b=function(){function a(){this._cacheUserInfo=[],this._cacheGroupInfo=[],this.totalUnreadCount=0,this.connectionState=!0,this.voiceSound=!1,this.currentUserInfo={}}return a.prototype._getCacheUserInfo=function(a){for(var b=0,c=this._cacheUserInfo.length;c>b;b++)if(this._cacheUserInfo[b].userId==a)return this._cacheUserInfo[b];return null},a.prototype._addUserInfo=function(a){var b=this._getCacheUserInfo(a.userId);b?angular.extend(b,a):this._cacheUserInfo.push(a)},a}();a.ProviderData=b;var c=(function(){function a(){}return a}(),function(){function b(){this.displayConversationList=!1,this.conversationListPosition=a.EnumConversationListPosition.left,this.displayMinButton=!0,this.desktopNotification=!1,this.reminder="",this.voiceNotification=!1,this.style={positionFixed:!1,width:450,height:470,bottom:0,right:0},this.refershOnlineStateIntercycle=2e4,this.hiddenConversations=[],this.__isKefu=!1}return b}());a.WidgetConfig=c,angular.module("RongWebIMWidget").service("ProviderData",b).service("WidgetConfig",c)}(RongWebIMWidget||(RongWebIMWidget={})),angular.module("RongWebIMWidget").run(["$templateCache",function(a){"use strict";a.put("./ts/conversation/conversation.tpl.html",'<div id=rong-conversation class="rongcloud-kefuChatBox rongcloud-both rongcloud-am-fade-and-slide-top" ng-show=showSelf ng-class="{\'rongcloud-fullScreen\':resoures.fullScreen}"><evaluatedir type=evaluate.type display=evaluate.showSelf confirm=evaluate.onConfirm(data) cancle=evaluate.onCancle()></evaluatedir><div class=rongcloud-kefuChat><div id=header class="rongcloud-rong-header rongcloud-blueBg rongcloud-online"><div class="rongcloud-infoBar rongcloud-pull-left"><div class=rongcloud-infoBarTit><span class=rongcloud-kefuName ng-bind=conversation.title></span></div></div><div class="rongcloud-toolBar rongcloud-headBtn rongcloud-pull-right"><div ng-show=!config.displayConversationList&&config.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><a href=javascript:; class="rongcloud-kefuChatBoxHide rongcloud-sprite" style=margin-right:6px ng-show=!config.displayConversationList ng-click=minimize() title=隐藏></a> <a href=javascript:; class="rongcloud-kefuChatBoxClose rongcloud-sprite" ng-click=close() title=结束对话></a></div></div><div class=rongcloud-outlineBox ng-hide=data.connectionState><div class=rongcloud-sprite></div><span>连接断开,请刷新重连</span></div><div id=Messages><div class=rongcloud-emptyBox>暂时没有新消息</div><div class=rongcloud-MessagesInner><div ng-repeat="item in messageList" ng-switch=item.panelType><div class=rongcloud-Messages-date ng-switch-when=104><b>{{item.sentTime|historyTime}}</b></div><div class=rongcloud-Messages-history ng-switch-when=105><b ng-click=getHistory()>查看历史消息</b></div><div class=rongcloud-Messages-history ng-switch-when=106><b ng-click=getMoreMessage()>获取更多消息</b></div><div class=rongcloud-sys-tips ng-switch-when=2><span ng-bind-html=item.content.content|trustHtml></span></div><div class="rongcloud-Message rongcloud-clearfix" ng-class="{\'rongcloud-Message-send\': item.messageDirection == 1}" ng-switch-when=1><div class=rongcloud-Messages-unreadLine></div><div><div class=rongcloud-Message-header><img class="rongcloud-img rongcloud-u-isActionable rongcloud-Message-avatar rongcloud-avatar" ng-src={{item.content.userInfo.portraitUri||item.content.userInfo.icon}} err-src=http://7xo1cb.com1.z0.glb.clouddn.com/rongcloudkefu2.png errsrcserasdfasdfasdfa alt=""><div class="rongcloud-Message-author rongcloud-clearfix" ng-if="item.messageDirection == 2"><a class="rongcloud-author rongcloud-u-isActionable">{{item.content.userInfo.name}}</a></div></div></div><div class=rongcloud-Message-body ng-switch=item.messageType><textmessage ng-switch-when=TextMessage msg=item.content></textmessage><imagemessage ng-switch-when=ImageMessage msg=item.content></imagemessage><voicemessage ng-switch-when=VoiceMessage msg=item.content></voicemessage><locationmessage ng-switch-when=LocationMessage msg=item.content></locationmessage><richcontentmessage ng-switch-when=RichContentMessage msg=item.content></richcontentmessage></div></div></div></div></div><div id=footer class=rongcloud-rong-footer style="display: block"><div class=rongcloud-footer-con><div class=rongcloud-text-layout><div id=funcPanel class="rongcloud-funcPanel rongcloud-robotMode"><div class=rongcloud-mode1 ng-show="_inputPanelState==0"><div class=rongcloud-MessageForm-tool id=expressionWrap><i class="rongcloud-sprite rongcloud-iconfont-smile" ng-click="showemoji=!showemoji"></i><div class=rongcloud-expressionWrap ng-show=showemoji><i class=rongcloud-arrow></i><emoji ng-repeat="item in emojiList" item=item content=conversation></emoji></div></div><div class=rongcloud-MessageForm-tool><i class="rongcloud-sprite rongcloud-iconfont-upload" id=upload-file style="position: relative; z-index: 1"></i></div></div><div class=rongcloud-mode2 ng-show="_inputPanelState==2"><a ng-click=switchPerson() id=chatSwitch class=rongcloud-chatSwitch>转人工服务</a></div></div><pre id=inputMsg class="rongcloud-text rongcloud-grey" contenteditable contenteditable-dire ng-focus="showemoji=fase" style="background-color: rgba(0,0,0,0);color:black" ctrl-enter-keys fun=send() ctrlenter=false placeholder=请输入文字... ondrop="return false" ng-model=conversation.messageContent></pre></div><div class=rongcloud-powBox><button type=button style="background-color: #0099ff" class="rongcloud-rong-btn rongcloud-rong-send-btn" id=rong-sendBtn ng-click=send()>发送</button></div></div></div></div></div>'),
a.put("./ts/conversationlist/conversationList.tpl.html",'<div id=rong-conversation-list class="rongcloud-kefuListBox rongcloud-both"><div class=rongcloud-kefuList><div class="rongcloud-rong-header rongcloud-blueBg"><div class="rongcloud-toolBar rongcloud-headBtn"><div ng-show=config.voiceNotification class=rongcloud-voice ng-class="{\'rongcloud-voice-mute\':!data.voiceSound,\'rongcloud-voice-sound\':data.voiceSound}" ng-click="data.voiceSound=!data.voiceSound"></div><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent>最近联系人</span><div class="rongcloud-sprite rongcloud-arrow-down" style="cursor: pointer" ng-click=minbtn()></div></div></div><div class=rongcloud-content><div class=rongcloud-netStatus ng-hide=data.connectionState><div class=rongcloud-sprite></div><span>连接断开,请刷新重连</span></div><div><conversation-item ng-repeat="item in conversationListServer._conversationList" item=item></conversation-item></div></div></div></div>'),a.put("./ts/evaluate/evaluate.tpl.html",'<div class=rongcloud-layermbox ng-show=display><div class=rongcloud-laymshade></div><div class=rongcloud-layermmain><div class=rongcloud-section><div class=rongcloud-layermchild ng-show=!end><div class=rongcloud-layermcont><div class=rongcloud-type1 ng-show="type==1"><h4>&nbsp;评价客服</h4><div class=rongcloud-layerPanel1><div class=rongcloud-star><span ng-repeat="item in stars track by $index"><span ng-class="{\'rongcloud-star-on\':$index<data.stars,\'rongcloud-star-off\':$index>=data.stars}" ng-click=confirm($index+1) ng-mouseenter=mousehover($index+1) ng-mouseleave=mousehover(0)></span></span></div></div></div><div class=rongcloud-type2 ng-show="type==2"><h4>&nbsp;&nbsp;机器人是否解决了您的问题 ？</h4><div class=rongcloud-layerPanel1><a class="rongcloud-rong-btn rongcloud-btnY" ng-class="{\'rongcloud-cur\':data.value===true}" href=javascript:void(0); ng-click=confirm(true)>是</a> <a class="rongcloud-rong-btn rongcloud-btnN" ng-class="{\'rongcloud-cur\':data.value===false}" href=javascript:void(0); ng-click=confirm(false)>否</a></div></div><div class=rongcloud-layerPanel2 ng-show=displayDescribe><p>是否有以下情况 ？</p><div class=rongcloud-labels><span ng-repeat="item in labels"><a class=rongcloud-rong-btn ng-class="{\'rongcloud-cur\':item.selected}" ng-click="item.selected=!item.selected" href="">{{item.display}}</a></span></div><div class=rongcloud-suggestBox><textarea name="" placeholder=欢迎给我们的服务提建议~ ng-model=data.describe></textarea></div><div class=rongcloud-subBox><a class=rongcloud-rong-btn href="" ng-click=commit()>提交评价</a></div></div></div><div class=rongcloud-layermbtn><span ng-click=confirm()>跳过</span><span ng-click=cancle()>取消</span></div></div><div class="rongcloud-layermchild rongcloud-feedback" ng-show=end><div class=rongcloud-layermcont>感谢您的反馈 ^ - ^ ！</div></div></div></div></div>'),a.put("./ts/main.tpl.html",'<div id=rong-widget-box class=rongcloud-container><div ng-show=main.display><rong-conversation></rong-conversation><rong-conversation-list></rong-conversation-list></div><div id=rong-widget-minbtn class="rongcloud-kefuBtnBox rongcloud-blueBg" ng-show=!main.display&&config.displayMinButton ng-click=showbtn()><a class=rongcloud-kefuBtn href="javascript: void(0);"><div class="rongcloud-sprite rongcloud-people"></div><span class=rongcloud-recent ng-show="!data.totalUnreadCount||data.totalUnreadCount==0">{{config.reminder||"最近联系人"}}</span> <span class=rongcloud-recent ng-show="data.totalUnreadCount>0"><span ng-show=twinkle>(有未读消息)</span></span></a></div><div id=rong-widget-minbtn-kefu class="rongcloud-kefuBtnBox rongcloud-blueBg" ng-show=!main.display&&config.displayMinButton ng-click=showbtn()><a class=rongcloud-kefuBtn href="javascript: void(0);"><div class="rongcloud-sprite rongcloud-people rongcloud-sprite-kefu"></div><span class=rongcloud-recent>{{config.reminder||"联系客服"}}</span></a></div><audio id=rongcloud-playsound style="width: 0px;height: 0px;display: none" src="" controls></audio></div>')}]);